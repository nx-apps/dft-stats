<link rel="import" href="./../../components/month-behavior.html">
<link rel="import" href="../../components/vaadin-gird-filter-common.html">
<link rel="import" href="./../../../../bower_components/vaadin-grid/vaadin-grid.html">

<link rel="import" href="./../../../../bower_components/paper-checkbox/paper-checkbox.html">

<dom-module id="hamonize-search">
    <style include="page-style flex-style">
        vaadin-grid {
            margin: 0px;
            width: 100%;
        }
    </style>
    <template>
        <paper-material elevation="1">
            <div class="container">
                <div class="flex-horizontal-with-ratios">
                    <div class="flexchild"></div>
                    <div class="flexchild"></div>
                    <div class="flexchild"></div>
                    <div class="labelSearchDate">
                        เริ่มวันที่ :
                    </div>
                    <div class="flex2child">
                        <vaadin-date-picker class="textCenter" value="{{data.dateStart}}" on-value-changed="setHamonizeSdate"></vaadin-date-picker>
                    </div>
                    <!-- [[obDate(data.sdate)]] -->
                    <div class="flexchild"></div>
                    <div class="labelSearchDate">
                        ถึงวันที่ :
                    </div>
                    <div class="flex2child">
                        <vaadin-date-picker class="textCenter" value="{{data.dateEnd}}" on-value-changed="setHamonizeEdate"></vaadin-date-picker>
                    </div>
                    <div class="flexchild"></div>
                    <div class="flexchild"></div>
                    <div class="flexchild"></div>
                    <div class="flexchild"></div>
                </div>
                <div class="flex-horizontal-with-ratios">
                    <div class="flexchild"></div>
                    <div class="labelSearchDate">
                        ปี :
                        <!-- เลขพิกัดศุลกากร : -->
                    </div>
                    <div class="flex2child">
                        <gl-combo-box id="hamonizeSearch" placeholder="ปี" class="textCenter" items="{{listYear}}" item-label-path="year" item-value-path="year"
                            value="{{data.hmYear}}" on-value-changed="getYearRice">
                            <template>
                                [[item.year]]
                            </template>
                        </gl-combo-box>
                        <!-- <gl-combo-box id="hamonizeSearch" placeholder="เลือกเลขพิกัดข้าว" class="textCenter" items="{{hamonizeCodeList.use}}" item-label-path="label"
                            item-value-path="label" value="{{data.hmparent}}" on-value-changed="getChildHm">
                            <template>
                                [[item.label]]
                            </template>
                        </gl-combo-box> -->
                    </div>
                    <!--<div class="labelSearchDate">
                        เรียงโดย : 
                    </div>
                    <div class="flexchild">
                        <gl-combo-box id="hamonizeOrderBy" class="textCenter" item-label-path="label" item-value-path="id" value="{{data.orderby}}">
                            <template>
                                [[item.label]]
                            </template>
                        </gl-combo-box>
                    </div>-->
                    <!--<div class="labelSearchDate">
                        แหล่งข้อมูล :
                    </div>
                    <div class="flexchild">
                        <gl-combo-box id="hamonizeSourch" class="textCenter" items="{{dataSourch}}" item-label-path="label" item-value-path="id"
                            value="{{data.refDB}}">
                            <template>
                                [[item.label]]
                            </template>
                        </gl-combo-box>
                    </div>-->
                    <div class="flexchild">
                        <div class="btn-search">
                            <paper-button raised class="gl-btn-info gl-small" on-tap="getRiceValue">
                                <iron-icon icon="search"></iron-icon>
                                ค้นหา
                            </paper-button>
                        </div>
                    </div>
                    <div class="flexchild"></div>
                </div>
                <div class="flex-horizontal-with-ratios">
                    <div class="flexchild">
                        <div class="btn-search">
                            <!-- <paper-button raised class="gl-btn-info gl-small" on-tap="getRiceValueReport">
                                <iron-icon icon="assignment"></iron-icon>
                                ออกรายงาน
                            </paper-button> -->
                        </div>
                    </div>
                    <div class="flex3child">
                    </div>
                </div>

                <!-- <paper-button raised on-tap="getHm">กด</paper-button> -->

                <div class="flex-horizontal-with-ratios">
                    <!-- <div class="flexchild"></div> -->
                    <!-- <div class="flexchild"> -->
                    <vaadin-grid id="material" items="[[hmChild]]" inverted$="[[inverted]]">

                        <vaadin-grid-column width="50px" flex-grow="0">
                            <template class="header">
                                <!--<paper-checkbox on-click="_invert" checked="[[_isChecked(inverted, indeterminate)]]" indeterminate="[[indeterminate]]">เลือกทั้งหมด</paper-checkbox>-->
                            </template>
                            <template>
                                <div class="text-center">
                                    <paper-checkbox on-change="_selectItem" checked="[[_isSelected(inverted, selected)]]"></paper-checkbox>
                                </div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="250px" flex-grow="0" resizable>
                            <template class="header">พิกัดข้าว
                                <vaadin-gird-filter-common aria-label="Rice Name" path="hamonize_code" value="[[_hamonize_code]]">
                                </vaadin-gird-filter-common>
                            </template>
                            <template>[[item.hamonize_code]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="450px" flex-grow="0" resizable>
                            <template class="header">ชื่อชนิดข้าว (ไทย)
                                <vaadin-gird-filter-common aria-label="Rice Name" path="hamonize_th" value="[[_hamonize_th]]">
                                </vaadin-gird-filter-common>

                            </template>
                            <template>[[item.hamonize_th]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="449px" flex-grow="0">
                            <template class="header">ชื่อชนิดข้าว (อังกฤษ)
                                <vaadin-gird-filter-common aria-label="Rice Name" path="hamonize_en" value="[[_hamonize_en]]">
                                </vaadin-gird-filter-common>
                            </template>
                            <template>[[item.hamonize_en]]</template>
                        </vaadin-grid-column>

                    </vaadin-grid>
                    <!-- </div> -->
                    <!-- <div class="flexchild"></div> -->
                </div>
            </div>


        </paper-material>
    </template>
    <script>
        Polymer({
            is: 'hamonize-search',
            behaviors: [
                ReduxBehavior,
                MonthBehavior
            ],
            properties: {
                hamonizeCodeList: {
                    statePath: 'hamonize.hamonizeCodeList',
                    observer: '_setItem'
                },
                date: {
                    statePath: 'hamonize.date',
                    observer: '_setDate'
                },
                inverted: {
                    type: Boolean,
                    value: false
                },
                indeterminate: {
                    type: Boolean,
                    value: false
                },
                hamonizeOrder: {
                    type: Array,
                    value: [
                        {
                            id: 'hamonize_code',
                            label: 'เลขพิกัด'
                        },
                        {
                            id: 'hamonize_th',
                            label: 'ชนิดข้าว'
                        },
                        {
                            id: 'net_weight_in',
                            label: 'ปริมาณนำเข้า'
                        },
                        {
                            id: 'net_weight_out',
                            label: 'ปริมาณส่งออก'
                        },
                        {
                            id: 'fob_amt_baht_in',
                            label: 'มูลค่านำเข้า'
                        },
                        {
                            id: 'fob_amt_baht_out',
                            label: 'มูลค่าส่งออก'
                        }
                    ]
                },
                dataSourch: {
                    type: Array,
                    value: [
                        {
                            id: 'f3',
                            label: 'ข้อมูลจากกรมการค้าต่างประเทศ'
                        },
                        {
                            id: 'custom',
                            label: 'ข้อมูลจากกรมศุลกากร'
                        }
                    ]
                },
                data: {
                    type: Object,
                    value: {},
                    notify: true
                },
                hmChild: {
                    type: Array,
                    value: []
                    // statePath: 'hamonize.hamonizeCodeChild',
                },
                statusCheck: {
                    type: Boolean,
                    value: true
                },
                listYear: {
                    statePath: 'hamonize.hamonizeCodeYear',
                    // type: Array,
                    // value: [
                    //     { year: '2007' },
                    //     { year: '2012' },
                    //     { year: '2017' }
                    // ]
                },
                listRice: {
                    statePath: 'hamonize.list_rice'
                }
            },
            //  check box
            observers: ['_resetSelection(inverted)'],
            _resetSelection: function (inverted) {
                this.$.material.selectedItems = [];
                this.updateStyles();
                this.indeterminate = false;
            },
            _invert: function (e) {
                // console.log(this.$.material.selectedItems.length);
                this.inverted = !this.inverted;
            },
            // iOS needs indeterminated + checked at the same time
            _isChecked: function (inverted, indeterminate) {
                return indeterminate || inverted;
            },
            _selectItem: function (e) {
                if (e.target.checked === this.inverted) {
                    this.$.material.deselectItem(e.model.item);
                } else {
                    this.$.material.selectItem(e.model.item);
                }
                // console.log(this.$.material.selectedItems.length);
                this.indeterminate = this.$.material.selectedItems.length > 0;
            },
            _isSelected: function (inverted, selected) {
                return inverted != selected;
            },
            getHm() {
                console.log(this.$.material.selectedItems);
            },
            // end check box
            // obdata(data) { console.log(data) },
            getYearRice(e) {
                var year = e.detail.value;
                if (year !== '' && typeof year !== 'undefined') {
                    // console.log(this.listRice);
                    // console.log(year);
                    let list_rice = this.listRice.filter((item) => { return item.hamonize_year == year });
                    // console.log(list_rice);
                    this.hmChild = list_rice;
                }
            },
            setHamonizeSdate(data) {
                try {
                    // console.log(data.detail.value);
                    let dateStart = new Date(data.detail.value).getFullYear(),
                        dateEnd = new Date(this.data.dateEnd).getFullYear()
                    this.setYearHamonize(dateStart, dateEnd)
                } catch (e) {
                }
            },
            setHamonizeEdate(data) {
                try {
                    // console.log(data.detail.value);
                    let dateStart = new Date(this.data.dateStart).getFullYear(),
                        dateEnd = new Date(data.detail.value).getFullYear()
                    this.setYearHamonize(dateStart, dateEnd)
                } catch (e) {
                }
            },
            _setItem(hmcode) {
                let dateStart = new Date(this.data.dateStart).getFullYear(),
                    dateEnd = new Date(this.data.dateEnd).getFullYear()
                this.setYearHamonize(dateStart, dateEnd)
                // console.log(this.hamonizeCodeList);
                // console.log(111);
            },
            setYearHamonize(Syear, Eyear) {
                if (!Number.isNaN(Syear) && !Number.isNaN(Eyear)
                    && this.hamonizeCodeList !== undefined) {
                    let hm = this.hamonizeCodeList
                    let startyear = '',
                        endyear = ''
                    for (var variable in hm) {
                        if (Number(variable) <= Syear)
                            startyear = variable
                    }
                    if (Syear === Eyear) {
                        // console.log(this.hamonizeCodeList[startyear]);
                        this.set('hamonizeCodeList.use', this.hamonizeCodeList[startyear])
                    } else {
                        // console.log(222);
                        for (var variable in hm) {
                            if (Number(variable) <= Eyear)
                                endyear = variable
                        }
                        //     console.log(222222);
                        //    console.log(this.hamonizeCodeList[startyear]);
                        //     console.log('Eyear',this.hamonizeCodeList[endyear]);
                        let newArr = this.hamonizeCodeList[startyear].concat(this.hamonizeCodeList[endyear])
                        this.set('hamonizeCodeList.use', newArr)
                        console.log(this.hamonizeCodeList.use.length);
                    }
                }
            },
            // getChildHm(e) {
            //     try {
            //         // console.log(e.detail.value.split(' ')[0]);
            //         let code = e.detail.value.split(' ')
            //         let hmparent = code[0]
            //         let year = code[code.length - 1].slice(0, 4)
            //         this.set('data.hamonizeYear', year)
            //         if (hmparent !== '' && hmparent !== undefined) {
            //             // console.log(this.data);
            //             let data = { 'hmparent': hmparent, 'year': this.data.hamonizeYear }
            //             this.dispatchAction('HAMONIZE_CODE_GET_CHILD', this.genUrl(data))
            //         }
            //     } catch (e) {
            //     }
            //     // 
            // },
            selectAll() {
                this.hmChild.map((set, index) => {
                    if (this.statusCheck) {
                        this.$.material.selectItem(set)
                    } else {
                        this.$.material.deselectItem(set)
                    }
                    // this.set('hmChild.' + index + '.check', this.statusCheck)
                })
                // this.fire('toast', { status: 'load' })
                // // console.log(this.statusCheck);
                // this.hmChild.map((set, index) => {
                //     // console.log(this.list_employees[index].budget_balance);
                //     // if (this.hmChild[index].budget_balance !== 0)
                //     this.set('hmChild.' + index + '.checks', this.statusCheck)
                //     // console.log(this.list_employees[index].budget_balance);
                // })
                // // this.set('paperFab', !this.statusCheck)
                // // console.log(this.paperFab);
                // this.fire('toast', { status: 'load' })
            },
            _setDate(e) {
                this.set('data.dateStart', e.dateStart)
                this.set('data.dateEnd', e.dateEnd);
                // this.set('data.refDB', 'f3');
                // data.dataSourch
                // (e.dateEnd != '') ? this.getRiceValue() : '';
            },
            getRiceValue() {
                // console.log(this.$.material.selectedItems);
                var selects = this.$.material.selectedItems;
                let arr = []
                // let rice = selects.filter((item) => item.checks === true)
                selects.map((id) => {
                    arr.push(id.hamonize_code)
                })
                // console.log(arr.join(','));
                var hmcodes = arr.join(',');
                var data = {
                    hmYear: this.data.hmYear,
                    hmCode: hmcodes,
                    dateStart: this.data.dateStart,
                    dateEnd: this.data.dateEnd
                }
                this.set('data', data)
                // console.log(data);
                this.dispatchAction('HAMONIZE_RICE_GET', data);
                // this.data.hmchild = arr
                // let code = this.data.hmparent.split(' ')
                // let hmparent = code[0]
                // // console.log(hmparent);
                // let newLink = this.data
                // newLink.hmparent = hmparent
                // // console.log(this.data);
                // // if (this.data.orderby == '') {
                // //     let comboboxhamonizeOrderBy = this.$$('#hamonizeOrderBy')
                // //     comboboxhamonizeOrderBy.value = 'hamonize_code'
                // //     this.data.orderby = 'hamonize_code'
                // // }
                // // if (this.data.hamonize_code == undefined || this.data.hamonize_code == '') {
                // // console.log(1);
                // this.dispatchAction('HAMONIZE_CODE_SEARCH_R1', this.genUrl(newLink))
                // // } else {
                // //     console.log(2);
                // //     this.dispatchAction('HAMONIZE_CODE_SEARCH_R1', this.genUrl(this.data))
                // //     // this.dispatchAction('HAMONIZE_CODE_SEARCH_R2', this.genUrl(this.data))
                // // }
            },
            getRiceValueReport() {
                let arr = []
                let rice = this.hmChild.filter((item) => item.checks === true)
                rice.map((id) => {
                    arr.push(id.id)
                })
                // console.log(arr);
                this.data.hmchild = arr
                let code = this.data.hmparent.split(' ')
                let hmparent = code[0]
                // console.log(hmparent);
                let newLink = this.data
                newLink.hmparent = hmparent
                // if (this.data.hamonize_code == undefined || this.data.hamonize_code == '') {
                window.open('./api/report/h01?' + this.genUrl(newLink))
                // } else {
                //     window.open('./api/report/h02?' + this.genUrl(this.data))
                // }
            }
        });
    </script>
</dom-module>